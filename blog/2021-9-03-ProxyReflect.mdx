---
slug: ä»£ç†ä¸åå°„
title: ä»£ç†ä¸åå°„
authors: peterroe
tags: [ä»£ç†ä¸åå°„]
---


## ä»£ç†ä¸åå°„

>å¼•è¨€ï¼š ä»£ç†ä¸åå°„å¬èµ·æ¥åƒæ˜¯javaScriptä¸åŒäºå…¶ä»–è¯­è¨€çš„ç‹¬æœ‰ç‰¹æ€§ï¼Œä»æŸäº›æ–¹é¢æ¥è¯´ï¼Œä»£ç†ç±»ä¼¼C++çš„æŒ‡é’ˆï¼Œä½†è¿™é‡Œå…ˆä¸è®¨è®ºå®ƒçš„å®šä¹‰ã€‚æ¥ä¸‹æ¥ç»™å‡ºå‡ ä¸ªä¾‹å­ï¼Œå°±å¾ˆå®¹æ˜“ç†è§£äº†

## åˆ›å»ºç©ºä»£ç†
```javascript
let target = {
    name: 'lihua',
    age: 18,
    array: [1, 2, 6]
}
let handler = {}

let proxy = new Proxy(target, handler)

//è¯æ˜proxyä¸targetçš„å±æ€§å¼•ç”¨çš„æ˜¯åŒä¸€å—åœ°å€ï¼Œå“ªæ€•æ˜¯åŸå§‹å€¼çš„ä¹Ÿæ˜¯åŒä¸€ä¸ªå€¼
console.log(target.array === proxy.array) //true 
proxy.age = 45
console.log(target.age === proxy.age) //true

//ç›¸ç­‰å¯ä»¥ç”¨æ¥åŒºåˆ†ä»£ç†å’Œåå°„
console.log(proxy === target)  //false ï¼šè¯æ˜proxyä¸targetå¹¶ä¸æ˜¯æŒ‡å‘åŒ
ä¸€ä¸ªåœ°å€

//Proxy.prototypeæ˜¯undefined
```
ä»£ç†æ˜¯ä½¿ç”¨Proxyæ„é€ å‡½æ•°åˆ›å»ºçš„ï¼Œè¿™ä¸ªæ„é€ å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå¯¹è±¡ï¼Œç¼ºå°‘ä»»ä½•ä¸€ä¸ªå‚æ•°éƒ½ä¼šæŠ›å‡º`TypeError`ã€‚

æœ€ç®€å•çš„ä»£ç†å°±æ˜¯åƒä¸Šé¢ç©ºä»£ç†ï¼Œå³é™¤äº†ä½œä¸ºä¸€ä¸ªæŠ½è±¡çš„ç›®æ ‡å¯¹è±¡ï¼Œä»€ä¹ˆä¹Ÿä¸åšï¼Œç±»ä¼¼ä¸å¦‚ä¸‹çš„è¡Œä¸º
```javascript
let a = 'name'
let b = [2, 4]
let target = {
    a,
    b
}
let proxy = {
    a,
    b
}
console.log(target.b === proxy.b)  //true
console.log(target === proxy)	//false
```

## å®šä¹‰æ•è·å™¨
ä¾‹å¦‚ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ª`get()`æ•è·å™¨ï¼Œ**å½“è¯•å›¾è®¿é—®targetçš„å±æ€§çš„æ—¶å€™**ï¼Œå®é™…ä¸Šè·å¾—çš„å€¼æ¥æºä¸`hander`çš„`get()`è¿”å›å€¼
```javascript
let target = {
    name: 'lihua'
}
let handler = {
    get() {
        return 'handle over'
    }
}
let proxy = new Proxy(target, handler)
console.log(proxy.name) //handle over
```
æ³¨æ„ä¸Šæ–‡åŠ ç²—çš„å­—ä½“ï¼ˆå½“è¯•å›¾è®¿é—®targetçš„å±æ€§çš„æ—¶å€™ï¼‰ï¼Œé‚£å‡å¦‚æˆ‘ä»¬ä¸è®¿é—®å±æ€§å‘¢ï¼Ÿ

é‚£**proxy**çš„å±æ€§å€¼å°±ä¸ä¼šè¢«`hander`å¤„ç†ï¼š

```javascript
let target = {
    name: 'Vue'
}
let handler = {
    get() {
        return 'React'
    }
}
let proxy = new Proxy(target, handler)

console.log(proxy) 	// { name: 'Vue' }
console.log(proxy.name) // React
```
è¿™æ˜¯ä¸æ™®é€šå¯¹è±¡ç›¸è¾ƒèµ·æ¥å¾ˆåŒªå¤·æ‰€æ€çš„ç°è±¡
:::caution
æ‰“å°`proxy`å¯¹è±¡å‘ç°æœ‰`name`å±æ€§ï¼Œå€¼æ˜¯**Vue**ï¼Œä½†æ˜¯è¯•å›¾è®¿é—®çš„æ—¶å€™å´å‘ç°**name**çš„å€¼æ˜¯**React**
:::
æ¥ä¸‹æ¥æ›´è¿›ä¸€æ­¥äº†è§£`hander`å¯¹è±¡ä¸`get()`æ•è·å™¨
## æ•è·å™¨å‚æ•°å’Œåå°„API
æ‰€æœ‰æ•è·å™¨éƒ½å¯ä»¥è®¿é—®å“åº”çš„å‚æ•°ï¼ŒåŸºäºè¿™äº›å‚æ•°å¯ä»¥é‡å»ºè¢«æ•è·æ–¹æ³•çš„åŸå§‹è¡Œä¸ºï¼Œæ¯”å¦‚ï¼Œ`get()`æ•è·å™¨ä¼šæ¥æ”¶åˆ°ä¸‰ä¸ªå‚æ•°ï¼š
* ğŸ¦„ ç›®æ ‡å¯¹è±¡
* ğŸ¾ è¦æŸ¥è¯¢çš„å±æ€§
* ğŸ´ ä»£ç†å¯¹è±¡

```javascript
let target = {
    name: 'lihua',
    age: 18,
    array: [1, 2, 6]
}
let handler = {
	//æ¥æ”¶ä¸‰ä¸ªå‚æ•°
    get(trapTarget, property, reciver) {
        console.log(trapTarget === target)
        console.log(property)
        console.log(reciver === proxy)
        return undefined
    }
}
let proxy = new Proxy(target, handler)
//å¦‚ä¸Šæ–‡æ‰€è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä¸å¦¨é—®proxyçš„å±æ€§ï¼Œhanderé‡Œçš„get()æ–¹æ³•æ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼Œæ²¡æœ‰ä»»ä½•è¾“å‡º

consoel.log(proxy.ageï¼‰  //è§¦å‘getæ–¹æ³•ï¼Œè¾“å‡º
//true
//age
//true
//undefined 	proxy.ageçš„å€¼ä¸ºgetæ–¹æ³•çš„è¿”å›å€¼
```
æœ‰äº†è¿™äº›å‚æ•°ï¼Œå°±å¯ä»¥é‡å»ºè¢«æ•è·çš„åŸå§‹è¡Œä¸ºï¼š
```javascript
let target = {
    name: 'lihua',
    age: 18,
    array: [1, 2, 6]
}
let handler = {
    get(trapTarget, property, reciver) {
        return trapTarget[property]
    }
}
let proxy = new Proxy(target, handler)
console.log(proxy.age) //18
```
æ‰€æœ‰æ•è·å™¨éƒ½å¯ä»¥åŸºäºè‡ªå·±çš„å‚æ•°é‡å»ºåŸå§‹æ“ä½œï¼Œä½†å¹¶éæ‰€æœ‰æ•è·å™¨è¡Œä¸ºéƒ½åƒget()é‚£ä¹ˆç®€å•ï¼Œå› æ­¤ï¼Œé€šè¿‡æ‰‹å†™ä»£ç å¦‚æ³•ç‚®åˆ¶çš„æƒ³æ³•æ˜¯ä¸ç°å®çš„

å¤„ç†ç¨‹åºå¯¹è±¡ä¸­æ‰€æœ‰å¯ä»¥æ•è·çš„æ–¹æ³•éƒ½æœ‰å¯¹åº”çš„åå°„ **(Reflect)API** æ–¹æ³•ï¼Œå¯ä»¥å‘è¿™æ ·å®šä¹‰å‡º**ç©ºä»£ç†å¯¹è±¡**ï¼š

```javascript
let target = {
    name: 'lihua',
    age: 18,
    array: [1, 2, 6]
}
let handler = {
    get(trapTarget, property, reciver) {
        return Reflect.get(trapTarget, property, reciver)
    }
}
let proxy = new Proxy(target, handler)
console.log(proxy.age) //18
```
ç”šè‡³`hander`è¿˜å¯ä»¥æ›´åŠ ç®€æ´ï¼š
```javascript
let handler = {
    get: Reflect.get
}
```
## ç®€å•åœ°åˆ©ç”¨åå°„å¤„ç†å€¼
```javascript
let target = {
    word: 'hello'
}
let handler = {
    get() {
        return Reflect.get(...arguments) + ' world'
    }
}
let proxy = new Proxy(target, handler)
console.log(proxy.word) //hello world
```
## ä»£ç†çš„æ¡ä»¶ - æ•è·å™¨ä¸å˜å¼
ä½¿ç”¨æ•è·å…¶å‡ ä¹å¯ä»¥æ”¹å˜æ‰€æœ‰åŸºæœ¬æ–¹æ³•çš„è¡Œä¸ºï¼Œä½†æ˜¯ä¹Ÿä¸æ˜¯æ²¡æœ‰é™åˆ¶ã€‚

æ•è·å¤„ç†ç¨‹åºçš„è¡Œä¸ºå¿…é¡»éµå®ˆ **æ•è·å™¨ä¸å˜å¼**ã€‚æ•è·å™¨ä¸å˜å¼å› æ–¹æ³•ä¸åŒè€Œå¼‚

æ¯”å¦‚ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡æœ‰ä¸€ä¸ª`ä¸å¯é…ç½®ä¸”ä¸å¯å†™`çš„æ•°æ®å±æ€§ï¼Œä¼šæŠ›å‡º**TypeError**
```javascript
let target = {
    word: 'hello'
}
Object.defineProperty(target, 'age', {
    writable: false,  //ä¸å¯é…ç½®
    configurable: false,  //ä¸”ä¸å¯å†™
    value: 48
})
let handler = {
    get() {
        return Reflect.get(...arguments) + ' world'
    }
}
let proxy = new Proxy(target, handler)
console.log(proxy.age) 
//TypeError
```
## å¯æ’¤é”€ä»£ç†
æœ‰æ—¶å€™å¯èƒ½éœ€è¦ä¸­æ–­ä»£ç†å¯¹è±¡ä¸ç›®æ ‡çš„è”ç³»ï¼Œå¦‚æœç”¨`new Proxy`æ„é€ å‡½æ•°åˆ›å»ºçš„å¯¹è±¡æ˜¯æ— æ³•æ’¤é”€ä»£ç†çš„

Proxyä¸Šæš´éœ²äº†ä¸€ä¸ª`revocable`æ–¹æ³•ï¼Œè¿™ä¸ªå·¥å‚æ–¹æ³•ç”¨äºåˆ›å»ºä»£ç†å¯¹è±¡å¹¶æš´éœ²ä¸€ä¸ª`revoke`æ’¤é”€æ–¹æ³•ï¼Œ**revocableæ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ç»“æ„ä¸ºï¼š {"proxy": proxy, "revoke": revoke}**

`Proxy.revocable`ç”¨äºæ’¤é”€ä»£ç†å¯¹è±¡ä¸ç›®æ ‡çš„å…³è”ï¼Œæ’¤é”€ä»£ç†çš„æ“ä½œæ˜¯ä¸å¯é€†çš„ã€‚
```javascript
let target = {
    word: 'hello'
}

let handler = {
    get() {
        return Reflect.get(...arguments) + ' world'
    }
}
let { proxy, revoke } = Proxy.revocable(target, handler)
console.log(proxy.word) //hello world
revoke()
console.log(proxy.word) //TypeError
```
## åå°„APIå’Œå¯¹è±¡API
åœ¨ä½¿ç”¨åå°„APIæ—¶ï¼Œè¦è®°ä½ï¼š
+ åå°„APIå¹¶ä¸é™äºæ•è·å¤„ç†ç¨‹åº
+ å¤§å¤šæ•°åå°„APIæ–¹æ³•åœ¨Objectç±»å‹ä¸Šéƒ½æœ‰å¯¹åº”æ–¹æ³•

é€šå¸¸ï¼ŒObjectä¸Šçš„æ–¹æ³•ç”¨äºé€šç”¨ç¨‹åºï¼Œè€Œåå°„æ–¹æ³•é€‚ç”¨äºç»†ç²’åº¦çš„å¯¹è±¡æ§åˆ¶ä¸æ“ä½œ

**1.çŠ¶æ€æ ‡è®°ï¼š**
	
å¾ˆå¤šåå°„æ–¹æ³•è¿”å›ç§°ä½œâ€œçŠ¶æ€æ ‡è®°â€çš„å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ„å›¾æ‰§è¡Œçš„æ“ä½œæ˜¯å¦	æˆåŠŸã€‚æœ‰æ—¶å€™ï¼ŒçŠ¶æ€æ ‡è®°æ¯”é‚£äº›å¯èƒ½æŠ›å‡ºé”™è¯¯çš„æ–¹æ³•æ›´åŠ æœ‰ç”¨
```javascript
let o = {}
Object.freeze(o)
try {
    Object.defineProperty(o, 'name', { value: 'lihua' })
} catch (error) {
    console.log('error')
}
//error
```
ç”¨åå°„APIé‡æ„
```javascript
const o = {}
Object.freeze(o)
if (Reflect.defineProperty(o, 'name', { value: 'lihua' })) {
    console.log('success')
} else {
    console.log('fail')
}
//fail
```
ä»¥ä¸‹åå°„æ–¹æ³•éƒ½ä¼šæä¾›çŠ¶æ€æ ‡è®°
```javascript
Reflect.defineProperty()
Reflect.preventExtensions()
Reflect.setPrototypeOf()
Reflect.set()
Reflect.deleteProperty()
```
**2.ç”¨ä¸€ç­‰å‡½æ•°æ›¿ä»£æ“ä½œç¬¦**

ä»¥ä¸‹åå°„æ–¹æ³•æä¾›åªæœ‰æ“ä½œç¬¦æ‰èƒ½å®Œæˆçš„æ“ä½œ

**Reflect.get()**: å¯ä»¥æ›¿ä»£å¯¹è±¡å±æ€§è®¿é—®æ“ä½œæ³•

**Reflect.set()**: å¯ä»¥æ›¿ä»£ `=` èµ‹å€¼æ“ä½œç¬¦

**Reflect.has()**: å¯ä»¥æ›¿ä»£` in` æ“ä½œç¬¦æˆ– `with()`

**Reflect.deleteProperty()**: å¯ä»¥æ›¿ä»£`delete`æ“ä½œç¬¦

**Reflect.construct()**: å¯ä»¥æ›¿ä»£`new`æ“ä½œç¬¦

ç¤ºä¾‹ï¼š
```javascript
let o = {
    name: 'ming'
}
// Reflect.get(): å¯ä»¥æ›¿ä»£å¯¹è±¡å±æ€§è®¿é—®æ“ä½œæ³•
console.log(Reflect.get(o, 'name'))  //ming

// Reflect.set(): å¯ä»¥æ›¿ä»£=èµ‹å€¼æ“ä½œç¬¦
Reflect.set(o, 'age', 18)  

// Reflect.has(): å¯ä»¥æ›¿ä»£ in æ“ä½œç¬¦æˆ– with()
console.log(Reflect.has(o, 'age'))  //true

// Reflect.deleteProperty(): å¯ä»¥æ›¿ä»£deleteæ“ä½œç¬¦
console.log(Reflect.deleteProperty(o, 'name')) //true

// Reflect.construct(): å¯ä»¥æ›¿ä»£newæ“ä½œç¬¦
console.log(Reflect.construct(Array, [2, 5, 6])) //[ 2, 5, 6 ]
```
## ä»£ç†å¦ä¸€ä¸ªä»£ç†
ä»£ç†å¯ä»¥æ‹¦æˆªåå°„APIçš„æ“ä½œï¼Œè€Œè¿™æ„å‘³ç€å®Œå…¨å¯ä»¥åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡å»ä»£ç†å¦ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ç›®æ ‡å¯¹è±¡ä¸Šæ„å»ºå¤šå±‚æ‹¦æˆªç½‘
```javascript
let target = {
    name: 'lihua'
}

let firstProxy = new Proxy(target, {
    get() {
        console.log('first proxy')
        return Reflect.get(...arguments)
    }
})

let secondProxy = new Proxy(firstProxy, {
    get() {
        console.log('second proxy')
        return Reflect.get(...arguments)
    }
})

console.log(secondProxy.name)
//second proxy
//first proxy
//lihua
```

## ä»£ç†çš„é—®é¢˜ä¸ä¸è¶³
ä»£ç†æ˜¯åœ¨**ECMAScript**ç°æœ‰çš„åŸºç¡€ä¸Šæ„å»ºèµ·æ¥çš„ä¸€å¥—æ–°APIï¼Œå› æ­¤å…¶å®å·²ç»å°½åŠ›åšåˆ°æœ€å¥½äº†ã€‚ä½†æ˜¯æŸäº›æƒ…å†µä¸‹ï¼Œä»£ç†ä¹Ÿä¸èƒ½ä¸ç°åœ¨çš„**ECMAScript**æœºåˆ¶å¾ˆå¥½çš„ååŒ

**1.ä»£ç†ä¸­çš„this**

ä»£ç†ç°åœ¨çš„ä¸€ä¸ªé—®é¢˜æ¥æºæ˜¯thiså€¼ã€‚
```javascript
let target = {
    thisVal() {
        console.log(this === proxy)
        console.log(this === target)
    }
}
let proxy = new Proxy(target, {})
proxy.thisVal()
// true
// false
target.thisVal()
// false 
// true
```
å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ç¬¦åˆé¢„æœŸçš„è¡Œä¸ºã€‚å¯æ˜¯å¦‚æœç›®æ ‡å¯¹è±¡ä¾èµ–äºå¯¹è±¡æ ‡è¯†ï¼Œé‚£å°±å¯èƒ½ç¢°åˆ°æ„æ–™ä¹‹å¤–çš„æƒ…å†µï¼Œæ¥çœ‹ä¸€ä¸ªç¨å¾®è½¬ä¸ªå¼¯çš„ä¾‹å­ï¼š
```javascript
const wm = new WeakMap()

class User {
    constructor(userId) {
        wm.set(this, userId)
    }
    set id(userId) {
        wm.set(this, userId)
    }
    get id() {
        return wm.get(this)
    }
}
const user = new User(123)
const proxy = new Proxy(user, {})	//ä¸¤æ¬¡è®¿é—®çš„thisæ˜¯ä¸åŒçš„
console.log(proxy.id) 
//undefined
```
è¿™æ˜¯å› ä¸º`User`å®ä¾‹ä¸€å¼€å§‹ä½¿ç”¨ç›®æ ‡å¯¹è±¡ä½œä¸º**WeakMap**çš„é”®ï¼Œä»£ç†å¯¹è±¡å´å°è¯•ä»è‡ªèº«å–å¾—è¿™ä¸ªå®ä¾‹ã€‚

è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±è¦é‡æ–°é…ç½®ä»£ç†ï¼ŒæŠŠä»£ç†`User`å®ä¾‹æ”¹ä¸ºä»£ç†`User`ç±»æœ¬èº«ã€‚ä¹‹åå†åˆ›å»ºä»£ç†çš„å®ä¾‹å°±ä¼šä»¥è¿™ä¸ªä»£ç†å®ä¾‹ä½œä¸º**WeakMap**çš„é”®äº†
```javascript
const wm = new WeakMap()

class User {
    constructor(userId) {
        wm.set(this, userId)
    }
    set id(userId) {
        wm.set(this, userId)
    }
    get id() {
        return wm.get(this)
    }
}

const UserClassProxy = new Proxy(User, {})
const proxyUser = new UserClassProxy(123)
console.log(proxyUser.id) //123
```
